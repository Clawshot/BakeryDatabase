from flask import Flask, render_template, request
import sqlite3
import datetime as dt

# Connect to SQLite database
database = sqlite3.connect('bakery.db')
cursor = database.cursor()


app = Flask(__name__)

@app.route("/")
def home():
    return render_template("home.html")

@app.route("/", methods=["POST"])
def clicked():
    return "Button was clicked! Flask received it on the backend."

@app.route("/about")
def about():
    return render_template("about.html")

order_dict = {}

def push_name(name):
    if name in order_dict:
        order_dict[name] += 1   # increment counter
    else:
        order_dict[name] = 1
    print(order_dict)

#cursor.execute("SELECT * FROM Products WHERE Name = ?", ("Relampago",))
#results = cursor.fetchone()
#testing_order()

#cursor.execute("SELECT * FROM Products WHERE Name = ?", ("Tartaleta",))
#results = cursor.fetchone()
#testing_order()
results = ""
@app.route("/order", methods=["POST"])
def order():
    product = request.form["product"] 
    results = str(cursor.execute("SELECT * FROM Products WHERE Name = ?", ("product",)))
    print(results)
    push_name(results)                  # run your function
    return f"You clicked {product}. Order updated!"

total = sum(price * qty for (_, price, _, _), qty in order_dict.items())
order_as_string = str(order_dict)
today = today = dt.datetime.now().isoformat(sep=' ', timespec='seconds')


cursor.execute(
    "INSERT INTO Ventas (FechayHora, Contenido, Total) VALUES (?,?,?)",
      (today, order_as_string, total))
database.commit()



if __name__ == "__main__":
    app.run(debug=True)
